#!/bin/bash

while getopts ":s:t:p:" opt; do
  case $opt in
    s)
      STORY_ID=$OPTARG
      ;;
    t)
      STORY_TYPE=$OPTARG
      ;;
    p)
      PROJECT_ID=$OPTARG
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      ;;
  esac
done

shift $(( OPTIND - 1 ))
BRANCH_DESC=$1

if [ -z "$STORY_ID" ]; then
  if [ -z "$PROJECT_ID" ]; then
    GIT_ROOT=$(git rev-parse --show-toplevel)
    PROJECT_ID=$(cat $GIT_ROOT/.pivotal)
  fi

  RESPONSE=$(curl -s -X POST \
       -H "Content-Type:application/json" \
       -H "X-TrackerToken:$PIVOTAL_TOKEN" \
       -d "{\"story_type\":\"$STORY_TYPE\",\"name\":\"$BRANCH_DESC\"}" \
       "https://www.pivotaltracker.com/services/v5/projects/$PROJECT_ID/stories")
  NEW_STORY_ID=$(echo $RESPONSE | sed 's/.*, "id"\: //g' | sed 's/,.*//g')
  STORY_ID=$NEW_STORY_ID
fi

git checkout -t -b $STORY_TYPE/$STORY_ID/$BRANCH_DESC

if [ -n "$NEW_STORY_ID" ]; then
  open https://www.pivotaltracker.com/story/show/$STORY_ID
fi
