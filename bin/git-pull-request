#!/bin/bash

#   TODO
#
#   * Better preconditions. need to validate
#     1. Existance of Pivotal and GitHub environment variables
#     2. Format of branch name
#
#   * Better error handling for failed pulled requests. Should 
#     probably parse the JSON error response and translated into
#     a user-friendly message.
#
#   * Maybe look at making the '-f' option on the push command 
#     optional
#
#   * Capture the URL of the pull request and launch a browser

current_branch=$(git rev-parse --abbrev-ref HEAD)
git push -f origin $current_branch

story_id=$(echo $current_branch | cut -d"/" -f 2)
story_json=$(curl -s -H "X-TrackerToken:$PIVOTAL_TOKEN" \
        "https://www.pivotaltracker.com/services/v5/stories/$story_id")
story_name=$(echo $story_json | sed -e 's/.*"name": "//' -e 's/".*//')
story_description=$(echo $story_json | sed -e 's/.*"description": "//' -e 's/", .*//')

tracking_branch=$(git branch -vv | grep "*" | sed -e 's/.*\[//' -e 's/: .*//')
echo $current_branch
repo=$(git config --get remote.origin.url | sed -e 's/.*://' -e 's/\.git//')
pr_url="https://api.github.com/repos/$repo/pulls"

curl -H "Authorization:token $GITHUB_TOKEN" \
     -d "{ \"title\": \"$story_name\", \"body\": \"$story_description\", \"head\": \"the-container-store:$current_branch\", \"base\": \"the-container-store:$tracking_branch\" }" \
     $pr_url
